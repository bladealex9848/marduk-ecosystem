<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Acceso a .env - Marduk</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Toastify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/search.css">
    <link rel="stylesheet" href="../css/fixes.css">

    <!-- Tema oscuro/claro -->
    <script>
      // Verificar preferencia guardada
      const darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
      // Verificar preferencia del sistema
      const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

      // Aplicar tema oscuro si está habilitado o preferido por el sistema
      if (darkModeEnabled || (prefersDarkMode && darkModeEnabled !== 'false')) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkModeEnabled', 'true');
      }
    </script>

    <style>
        .result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Header/Navbar (Same as other pages) -->
    <header class="navbar navbar-expand-lg navbar-dark bg-gradient sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <i class="fas fa-balance-scale me-2"></i>
                <span>Marduk</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/solutions.html"><i class="fas fa-tools me-1"></i> Soluciones</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/community.html"><i class="fas fa-users me-1"></i> Comunidad</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/ai-test.html"><i class="fas fa-robot me-1"></i> Prueba IA</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html"><i class="fas fa-vial me-1"></i> Tests</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <!-- Search Form -->
                    <form class="d-flex me-2 search-container">
                        <div class="position-relative w-100">
                            <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                            <input class="form-control ps-5" type="search" placeholder="Buscar..." aria-label="Search">
                        </div>
                    </form>
                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="btn btn-link text-light me-3">
                        <i class="fas fa-moon"></i>
                    </button>
                    <!-- User Menu -->
                    <div class="dropdown">
                        <button class="btn btn-link d-flex align-items-center text-light text-decoration-none dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar-circle avatar-circle-sm bg-primary text-white me-2">
                                AF
                            </div>
                            <span class="d-none d-md-block">Alexander Fadul</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                            <li><a class="dropdown-item" href="../pages/profile.html"><i class="fas fa-user me-2"></i> Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="../pages/settings.html"><i class="fas fa-cog me-2"></i> Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <!-- Botón para volver a la página anterior -->
                <a href="javascript:history.back()" class="back-link">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                </a>

                <h1 class="mb-4"><i class="fas fa-key text-primary me-2"></i> Prueba de Acceso a .env</h1>
                <p class="lead mb-4">Esta página prueba si el archivo .env es accesible desde el servidor web y muestra métodos seguros para acceder a él.</p>

                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i> Advertencia de Seguridad</h5>
                    <p>El archivo <code>.env</code> contiene información sensible como API keys y credenciales. <strong>No debe ser accesible directamente desde el navegador</strong>.</p>
                    <p>Recomendaciones de seguridad:</p>
                    <ul>
                        <li>Usar permisos restrictivos (600 o 640) para el archivo .env</li>
                        <li>Configurar reglas en .htaccess para bloquear el acceso directo</li>
                        <li>Usar un proxy del lado del servidor para acceder a las variables de entorno</li>
                    </ul>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i> Prueba de Acceso Directo</h5>
                    </div>
                    <div class="card-body">
                        <p>Esta sección prueba si el archivo .env es accesible directamente desde el navegador. <strong>Idealmente, todas estas pruebas deberían fallar</strong> por seguridad.</p>

                        <div class="mb-4">
                            <button id="test-root" class="btn btn-primary me-2 mb-2"><i class="fas fa-file-alt me-1"></i> .env en raíz</button>
                            <button id="test-parent" class="btn btn-info me-2 mb-2"><i class="fas fa-level-up-alt me-1"></i> .env en directorio padre</button>
                            <button id="test-current" class="btn btn-success me-2 mb-2"><i class="fas fa-folder-open me-1"></i> .env en directorio actual</button>
                            <button id="test-test2" class="btn btn-warning me-2 mb-2"><i class="fas fa-file-code me-1"></i> .env.test2</button>
                        </div>

                        <div id="result" class="result">
                            <p>Haz clic en un botón para probar el acceso al archivo .env</p>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-lock me-2"></i> Método Seguro de Acceso</h5>
                    </div>
                    <div class="card-body">
                        <p>Esta sección demuestra cómo acceder de forma segura a las variables de entorno usando un proxy del lado del servidor.</p>

                        <div class="mb-4">
                            <button id="test-proxy" class="btn btn-success me-2 mb-2"><i class="fas fa-key me-1"></i> Obtener API Key vía Proxy</button>
                        </div>

                        <div id="proxy-result" class="result">
                            <p>Haz clic en el botón para obtener la API key de forma segura</p>
                        </div>
                    </div>
                </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resultDiv = document.getElementById('result');
            const proxyResultDiv = document.getElementById('proxy-result');

            // Función para probar el acceso a un archivo
            async function testAccess(url, description) {
                resultDiv.className = 'result';
                resultDiv.innerHTML = `<p>Probando acceso a ${description}...</p>`;

                try {
                    const response = await fetch(url);

                    if (response.ok) {
                        const content = await response.text();
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i> ¡Advertencia de Seguridad!</h5>
                                <p>✅ El archivo ${description} es accesible públicamente. Esto representa un riesgo de seguridad.</p>
                            </div>
                            <p>Código de estado: ${response.status}</p>
                            <p>Longitud del contenido: ${content.length} caracteres</p>
                            <p>Primeros 50 caracteres:</p>
                            <pre>${content.substring(0, 50)}</pre>
                            <div class="mt-3">
                                <h6>Recomendaciones:</h6>
                                <ul>
                                    <li>Cambiar los permisos del archivo a 600 o 640</li>
                                    <li>Configurar reglas en .htaccess para bloquear el acceso</li>
                                </ul>
                            </div>
                        `;

                        // Mostrar alerta con SweetAlert2
                        Swal.fire({
                            title: '¡Advertencia de Seguridad!',
                            text: `El archivo ${description} es accesible públicamente. Esto representa un riesgo de seguridad.`,
                            icon: 'warning',
                            confirmButtonText: 'Entendido'
                        });
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-circle me-2"></i> Acceso Bloqueado (Correcto)</h5>
                                <p>❌ El archivo ${description} no es accesible directamente. Esto es lo esperado por seguridad.</p>
                            </div>
                            <p>Código de estado: ${response.status}</p>
                            <p>Mensaje: ${response.statusText}</p>
                        `;
                    }
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i> Acceso Bloqueado (Correcto)</h5>
                            <p>❌ Error al acceder al archivo ${description}. Esto es lo esperado por seguridad.</p>
                        </div>
                        <p>Error: ${error.message}</p>
                    `;
                }
            }

            // Función para obtener la API key de forma segura vía proxy
            async function getApiKeyViaProxy() {
                proxyResultDiv.className = 'result';
                proxyResultDiv.innerHTML = `<p>Obteniendo API key vía proxy...</p>`;

                try {
                    // Primero, obtener un token de autenticación
                    const tokenResponse = await fetch('/get-auth-token.php');
                    if (!tokenResponse.ok) {
                        throw new Error(`Error al obtener token: ${tokenResponse.status} ${tokenResponse.statusText}`);
                    }

                    const tokenData = await tokenResponse.json();
                    if (!tokenData.success || !tokenData.data || !tokenData.data.token) {
                        throw new Error('Formato de respuesta de token inválido');
                    }

                    const token = tokenData.data.token;

                    // Luego, usar el token para obtener la API key
                    const apiKeyResponse = await fetch('/get-api-key.php', {
                        headers: {
                            'X-Auth-Token': token
                        }
                    });

                    if (!apiKeyResponse.ok) {
                        throw new Error(`Error al obtener API key: ${apiKeyResponse.status} ${apiKeyResponse.statusText}`);
                    }

                    const apiKeyData = await apiKeyResponse.json();
                    if (!apiKeyData.success) {
                        throw new Error(apiKeyData.message || 'Error desconocido');
                    }

                    // Mostrar resultado
                    proxyResultDiv.className = 'result success';
                    proxyResultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i> API Key Obtenida de Forma Segura</h5>
                            <p>La API key se obtuvo correctamente a través del proxy del servidor.</p>
                        </div>
                        <p><strong>API Key Disponible:</strong> ${apiKeyData.data.keyAvailable ? 'Sí' : 'No'}</p>
                        ${apiKeyData.data.key ? `<p><strong>API Key (primeros 10 caracteres):</strong> ${apiKeyData.data.key.substring(0, 10)}...</p>` : ''}
                        <div class="mt-3">
                            <h6>Ventajas de este método:</h6>
                            <ul>
                                <li>El archivo .env nunca se expone directamente</li>
                                <li>Se utiliza autenticación mediante tokens</li>
                                <li>Solo se devuelve la información necesaria</li>
                                <li>Compatible con permisos restrictivos (600/640) en el archivo .env</li>
                            </ul>
                        </div>
                    `;

                    // Mostrar alerta con SweetAlert2
                    Swal.fire({
                        title: 'Éxito',
                        text: 'API key obtenida de forma segura',
                        icon: 'success',
                        confirmButtonText: 'Genial'
                    });
                } catch (error) {
                    proxyResultDiv.className = 'result error';
                    proxyResultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-circle me-2"></i> Error</h5>
                            <p>No se pudo obtener la API key: ${error.message}</p>
                        </div>
                        <p>Asegúrate de que los scripts PHP de proxy estén correctamente configurados en el servidor.</p>
                    `;

                    // Mostrar alerta con SweetAlert2
                    Swal.fire({
                        title: 'Error',
                        text: `No se pudo obtener la API key: ${error.message}`,
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                }
            }

            // Eventos para los botones de prueba directa
            document.getElementById('test-root').addEventListener('click', () => {
                testAccess('/.env', '.env en la raíz');
            });

            document.getElementById('test-parent').addEventListener('click', () => {
                testAccess('../.env', '.env en el directorio padre');
            });

            document.getElementById('test-current').addEventListener('click', () => {
                testAccess('.env', '.env en el directorio actual');
            });

            document.getElementById('test-test2').addEventListener('click', () => {
                testAccess('.env.test2', '.env.test2');
            });

            // Evento para el botón de proxy seguro
            document.getElementById('test-proxy').addEventListener('click', () => {
                getApiKeyViaProxy();
            });
        });
    </script>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5 border-top">
        <div class="container">
            <div class="row justify-content-between align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5 class="h6 fw-bold text-primary">Marduk</h5>
                    <p class="small text-secondary mb-0">Ecosistema de soluciones para la transformación judicial</p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0 text-center">
                    <div class="d-flex flex-wrap justify-content-center gap-3 footer-links">
                        <a href="../pages/about.html" class="text-decoration-none text-secondary small">Acerca de</a>
                        <a href="../pages/policies.html" class="text-decoration-none text-secondary small">Políticas</a>
                        <a href="../pages/contribute.html" class="text-decoration-none text-secondary small">Contribuir</a>
                        <a href="../pages/support.html" class="text-decoration-none text-secondary small">Soporte</a>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <p class="small text-muted mb-0">© 2025 Rama Judicial de Colombia</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Inicializar el toggle de tema -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Inicializar el toggle de tema
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
          // Actualizar el icono según el tema actual
          if (document.body.classList.contains('dark-mode')) {
            themeToggle.querySelector('i').classList.remove('fa-moon');
            themeToggle.querySelector('i').classList.add('fa-sun');
          }

          // Agregar evento de click
          themeToggle.addEventListener('click', function() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
              document.documentElement.removeAttribute('data-theme');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('darkModeEnabled', 'false');
            } else {
              document.documentElement.setAttribute('data-theme', 'dark');
              document.body.classList.add('dark-mode');
              localStorage.setItem('darkModeEnabled', 'true');
            }

            // Actualizar el icono
            const themeIcon = themeToggle.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
              themeIcon.classList.remove('fa-moon');
              themeIcon.classList.add('fa-sun');
            } else {
              themeIcon.classList.remove('fa-sun');
              themeIcon.classList.add('fa-moon');
            }
          });
        }
      });
    </script>
</body>
</html>
