<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de OpenRouter - Marduk</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Toastify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/search.css">
    <link rel="stylesheet" href="../css/fixes.css">

    <!-- Tema oscuro/claro -->
    <script>
      // Verificar preferencia guardada
      const darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
      // Verificar preferencia del sistema
      const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

      // Aplicar tema oscuro si está habilitado o preferido por el sistema
      if (darkModeEnabled || (prefersDarkMode && darkModeEnabled !== 'false')) {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('darkModeEnabled', 'true');

        // Esperar a que el documento esté listo para modificar el body
        document.addEventListener('DOMContentLoaded', function() {
          document.body.classList.add('dark-mode');
        });
      }
    </script>

    <style>
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Estilos para modo oscuro */
        .dark-mode pre {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .dark-mode .result-container {
            background-color: #343a40 !important;
            color: #f8f9fa !important;
        }

        .dark-mode .card {
            background-color: #2c3034;
            color: #f8f9fa;
        }

        .dark-mode .card-header {
            background-color: #212529;
        }

        .dark-mode .list-group-item {
            background-color: #2c3034;
            color: #f8f9fa;
            border-color: #495057;
        }

        /* Estilos para el contenido Markdown */
        .markdown-content {
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            overflow-y: auto;
            max-height: 400px;
        }

        .dark-mode .markdown-content {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .markdown-content code {
            background-color: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .dark-mode .markdown-content code {
            background-color: #212529;
            color: #f8f9fa;
        }

        .markdown-content .code-block {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .dark-mode .markdown-content .code-block {
            background-color: #212529;
            color: #f8f9fa;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .model-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Header/Navbar (Same as other pages) -->
    <header class="navbar navbar-expand-lg navbar-dark bg-gradient sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <i class="fas fa-balance-scale me-2"></i>
                <span>Marduk</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/solutions.html"><i class="fas fa-tools me-1"></i> Soluciones</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/community.html"><i class="fas fa-users me-1"></i> Comunidad</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/ai-test.html"><i class="fas fa-robot me-1"></i> Prueba IA</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html"><i class="fas fa-vial me-1"></i> Tests</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <!-- Search Form -->
                    <form class="d-flex me-2 search-container">
                        <div class="position-relative w-100">
                            <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                            <input class="form-control ps-5" type="search" placeholder="Buscar..." aria-label="Search">
                        </div>
                    </form>
                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="btn btn-link text-light me-3">
                        <i class="fas fa-moon"></i>
                    </button>
                    <!-- User Menu -->
                    <div class="dropdown">
                        <button class="btn btn-link d-flex align-items-center text-light text-decoration-none dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar-circle avatar-circle-sm bg-primary text-white me-2">
                                AF
                            </div>
                            <span class="d-none d-md-block">Alexander Fadul</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                            <li><a class="dropdown-item" href="../pages/profile.html"><i class="fas fa-user me-2"></i> Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="../pages/settings.html"><i class="fas fa-cog me-2"></i> Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <!-- Botón para volver a la página anterior -->
                <a href="javascript:history.back()" class="back-link">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                </a>

                <h1 class="mb-4"><i class="fas fa-robot text-primary me-2"></i> Prueba Mejorada de OpenRouter</h1>
                <p class="lead mb-4">Esta página prueba la conexión con la API de OpenRouter de forma segura.</p>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-5">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Configuración</h5>
                    </div>
                    <div class="card-body">
                        <form id="test-form">
                            <div class="mb-3">
                                <label for="api-key" class="form-label">API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="api-key" placeholder="Ingresa tu API key">
                                    <button class="btn btn-outline-secondary" type="button" id="use-env-key">
                                        <i class="fas fa-key"></i> Usar de .env
                                    </button>
                                </div>
                                <div id="api-key-status" class="form-text">
                                    <span class="text-muted">Ingresa una API key o usa la de .env si está disponible.</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="model-select" class="form-label">Modelo</label>
                                <select class="form-select" id="model-select">
                                    <option value="" disabled selected>Cargando modelos...</option>
                                </select>
                                <div class="form-text">Modelos locales y gratuitos de la API.</div>
                            </div>

                            <div class="mb-3">
                                <label for="prompt" class="form-label">Prompt</label>
                                <textarea class="form-control" id="prompt" rows="3">Hola, ¿cómo estás?</textarea>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i>Enviar Solicitud
                                </button>
                                <button type="button" id="demo-mode-btn" class="btn btn-info">
                                    <i class="fas fa-vial me-2"></i>Modo Demostración
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Resultado</h5>
                    </div>
                    <div class="card-body">
                        <div id="result-container">
                            <p class="text-muted">El resultado se mostrará aquí...</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Modelos Disponibles</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="modelsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="local-tab" data-bs-toggle="tab" data-bs-target="#local" type="button" role="tab">
                                    Modelos Locales
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                                    Modelos API
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content mt-3" id="modelsTabContent">
                            <div class="tab-pane fade show active" id="local" role="tabpanel">
                                <div id="local-models" class="model-list">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2">Cargando modelos locales...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="api" role="tabpanel">
                                <div id="api-models" class="model-list">
                                    <div class="text-center py-3">
                                        <p class="text-muted">Los modelos de la API se cargarán cuando proporciones una API key válida.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/api-key-input.js"></script>
    <script src="../js/config/openrouter-models.js"></script>
    <script src="js/openrouter-api-models.js"></script>
    <script src="js/markdown-parser.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Elementos del DOM
            const testForm = document.getElementById('test-form');
            const apiKeyInput = document.getElementById('api-key');
            const apiKeyStatus = document.getElementById('api-key-status');
            const useEnvKeyBtn = document.getElementById('use-env-key');
            const modelSelect = document.getElementById('model-select');
            const promptInput = document.getElementById('prompt');
            const resultContainer = document.getElementById('result-container');
            const demoModeBtn = document.getElementById('demo-mode-btn');
            const localModelsContainer = document.getElementById('local-models');
            const apiModelsContainer = document.getElementById('api-models');

            // Variables para almacenar modelos
            let localModels = [];
            let apiModels = [];
            let envApiKey = null;

            // Verificar si tenemos una API key en window.ENV
            if (window.ENV && window.ENV.OPENROUTER_API_KEY) {
                envApiKey = window.ENV.OPENROUTER_API_KEY;
                console.log('API key disponible en window.ENV');
                apiKeyStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> API key cargada desde .env</span>';
                apiKeyInput.value = '********';
                useEnvKeyBtn.disabled = false;
            } else {
                console.log('No hay API key disponible en window.ENV');
                useEnvKeyBtn.disabled = true;
            }

            // Cargar modelos locales
            if (typeof OPENROUTER_MODELS_CONFIG !== 'undefined' && OPENROUTER_MODELS_CONFIG.models) {
                localModels = OPENROUTER_MODELS_CONFIG.models.map(model => ({...model, source: 'local'}));
                renderLocalModels();
                populateModelSelect();
            } else {
                localModelsContainer.innerHTML = '<p class="text-danger">Error al cargar modelos locales</p>';
            }

            // Inicializar el contenedor de modelos de la API con un mensaje informativo
            apiModelsContainer.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Modelos de la API</h6>
                    <p>Para cargar los modelos disponibles desde la API de OpenRouter, ingresa tu API key y haz clic en el botón "Cargar modelos de la API".</p>
                    <p class="mb-0"><small>Nota: Solo se mostrarán modelos gratuitos y de OpenRouter.</small></p>
                </div>
            `;

            // Evento para usar la API key de .env
            useEnvKeyBtn.addEventListener('click', async function() {
                if (envApiKey) {
                    apiKeyInput.value = '********'; // No mostrar la API key real
                    apiKeyStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Usando API key de .env</span>';

                    // Cargar modelos de la API usando el botón
                    if (loadApiModelsBtn) {
                        loadApiModelsBtn.click();
                    }
                } else {
                    // Usar SweetAlert para mostrar mensaje de error
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay API key disponible en .env',
                        icon: 'warning',
                        confirmButtonText: 'Entendido'
                    });
                }
            });

            // Evento para el cambio de API key
            apiKeyInput.addEventListener('input', function() {
                const apiKey = this.value.trim();
                if (apiKey && apiKey !== '********') {
                    apiKeyStatus.innerHTML = '<span class="text-info"><i class="fas fa-info-circle"></i> API key ingresada manualmente</span>';
                } else if (apiKey === '********' && envApiKey) {
                    apiKeyStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Usando API key de .env</span>';
                } else {
                    apiKeyStatus.innerHTML = '<span class="text-muted">Ingresa una API key o usa la de .env si está disponible.</span>';
                }
            });

            // Agregar botón para cargar modelos de la API
            const loadApiModelsBtn = document.createElement('button');
            loadApiModelsBtn.type = 'button';
            loadApiModelsBtn.className = 'btn btn-primary mt-2';
            loadApiModelsBtn.innerHTML = '<i class="fas fa-sync"></i> Cargar modelos de la API';
            loadApiModelsBtn.onclick = async function() {
                let apiKey = apiKeyInput.value.trim();

                // Si está usando la API key de .env
                if (apiKey === '********' && envApiKey) {
                    apiKey = envApiKey;
                }

                if (!apiKey) {
                    // Usar SweetAlert para mostrar mensaje de error
                    Swal.fire({
                        title: 'Error',
                        text: 'Por favor, ingresa una API key válida',
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                // Mostrar indicador de carga
                apiModelsContainer.innerHTML = `
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando modelos desde la API...</p>
                    </div>
                `;

                try {
                    // Cargar modelos de la API
                    await loadApiModels(apiKey);

                    // Mostrar mensaje de éxito con SweetAlert
                    Swal.fire({
                        title: 'Éxito',
                        text: `Se cargaron ${apiModels.length} modelos desde la API`,
                        icon: 'success',
                        confirmButtonText: 'Genial'
                    });
                } catch (error) {
                    // Mostrar mensaje de error con SweetAlert
                    Swal.fire({
                        title: 'Error',
                        text: `Error al cargar modelos: ${error.message}`,
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });

                    // Restaurar mensaje informativo
                    apiModelsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-circle"></i> Error al cargar modelos</h6>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            };

            // Agregar el botón después del campo de API key
            const apiKeyContainer = document.querySelector('.api-key-container') || apiKeyInput.parentNode;
            apiKeyContainer.appendChild(loadApiModelsBtn);

            // Evento para el formulario de prueba
            testForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Obtener valores
                let apiKey = apiKeyInput.value.trim();
                if (apiKey === '********' && envApiKey) {
                    apiKey = envApiKey;
                }

                // Si no hay API key, usar la de window.ENV
                if (!apiKey && window.ENV && window.ENV.OPENROUTER_API_KEY) {
                    apiKey = window.ENV.OPENROUTER_API_KEY;
                    console.log('Usando API key de window.ENV');
                }

                const modelId = modelSelect.value;
                const prompt = promptInput.value.trim();

                // Validar valores
                if (!apiKey) {
                    // Usar SweetAlert para mostrar mensaje de error
                    Swal.fire({
                        title: 'Error',
                        text: 'La API key es requerida. Por favor, ingresa una API key o asegúrate de que esté disponible en .env',
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                    console.error('No se encontró una API key válida');
                    return;
                }

                console.log('API key disponible: ********');

                if (!modelId) {
                    // Usar SweetAlert para mostrar mensaje de error
                    Swal.fire({
                        title: 'Error',
                        text: 'Debes seleccionar un modelo',
                        icon: 'warning',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                if (!prompt) {
                    // Usar SweetAlert para mostrar mensaje de error
                    Swal.fire({
                        title: 'Error',
                        text: 'El prompt es requerido',
                        icon: 'warning',
                        confirmButtonText: 'Entendido'
                    });
                    return;
                }

                // Mostrar indicador de carga
                showResult('loading', 'Enviando solicitud a OpenRouter...');

                try {
                    // Verificar que la API key sea válida
                    if (!apiKey || apiKey === 'demo' || apiKey === 'tu-api-key-aquí') {
                        throw new Error('API key no válida o no encontrada');
                    }

                    // Mostrar información de depuración
                    console.log('Enviando solicitud con los siguientes datos:');
                    console.log('- Modelo:', modelId);
                    console.log('- API key: ********');
                    console.log('- Prompt:', prompt);

                    // Preparar headers
                    const headers = {
                        "Authorization": `Bearer ${apiKey}`,
                        "HTTP-Referer": "https://marduk-ecosystem.com", // Usar un dominio fijo en lugar de window.location.origin
                        "X-Title": "Marduk Ecosystem",
                        "Content-Type": "application/json"
                    };

                    console.log('Headers:', JSON.stringify(headers, null, 2));

                    // Enviar solicitud a OpenRouter
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            model: modelId,
                            messages: [
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ]
                        })
                    });

                    // Obtener respuesta
                    const data = await response.json();

                    // Verificar si hay error
                    if (!response.ok) {
                        showResult('error', `Error: ${data.error?.message || 'Error desconocido'}`);
                        console.error('Error completo:', data);
                        return;
                    }

                    // Mostrar respuesta
                    showResult('success', data.choices[0].message.content, data.model);
                    console.log('Respuesta completa:', data);
                } catch (error) {
                    console.error('Error completo:', error);

                    // Intentar extraer el mensaje de error de la respuesta
                    let errorMessage = error.message;

                    if (error.error && error.error.message) {
                        errorMessage = error.error.message;
                    } else if (error.message === 'Failed to fetch') {
                        errorMessage = 'Error de conexión. Verifica tu conexión a Internet.';
                    } else if (error.message.includes('401')) {
                        errorMessage = 'Error de autenticación. La API key no es válida o ha expirado.';
                    }

                    showResult('error', `Error: ${errorMessage}`);

                    // Mostrar información adicional para depuración
                    const resultDiv = document.getElementById('result');
                    if (resultDiv) {
                        const debugInfo = document.createElement('div');
                        debugInfo.className = 'mt-3 small';
                        debugInfo.innerHTML = `
                            <div class="alert alert-warning">
                                <h6>Información de depuración:</h6>
                                <p><strong>API Key:</strong> ${apiKey ? '********' : 'No disponible'}</p>
                                <p><strong>Modelo:</strong> ${modelId || 'No seleccionado'}</p>
                                <p><strong>Error completo:</strong> ${error.toString()}</p>
                            </div>
                        `;
                        resultDiv.appendChild(debugInfo);
                    }
                }
            });

            // Evento para el botón de modo de demostración
            demoModeBtn.addEventListener('click', function() {
                // Mostrar indicador de carga
                showResult('loading', 'Generando respuesta en modo de demostración...');

                // Simular un retraso
                setTimeout(() => {
                    const prompt = promptInput.value.trim() || 'Hola, ¿cómo estás?';
                    const modelId = modelSelect.value || 'demo/model';

                    // Buscar información del modelo
                    const model = [...localModels, ...apiModels].find(m => m.id === modelId) || {
                        name: 'Modelo de Demostración',
                        provider: 'Demo'
                    };

                    // Generar respuesta simulada
                    let demoResponse;

                    // Respuestas predefinidas para preguntas comunes
                    const lowerPrompt = prompt.toLowerCase();

                    if (lowerPrompt.includes('hola')) {
                        demoResponse = `Hola, soy un asistente virtual basado en ${model.name}. Estoy funcionando en modo de demostración. ¿En qué puedo ayudarte?`;
                    } else if (lowerPrompt.includes('qué es marduk')) {
                        demoResponse = `Marduk es un ecosistema de herramientas digitales diseñadas para la transformación judicial. Incluye soluciones para la gestión de casos, análisis de datos jurídicos y asistencia en la toma de decisiones.`;
                    } else {
                        demoResponse = `En respuesta a tu consulta: "${prompt}"\n\nComo asistente virtual basado en ${model.name}, puedo proporcionarte información general sobre temas jurídicos y el ecosistema Marduk, pero mis capacidades son limitadas en este modo de demostración.`;
                    }

                    // Mostrar respuesta simulada
                    showResult('demo', demoResponse, `${model.provider}/${model.name} (Demo)`);
                }, 1500);
            });

            // Función para cargar modelos de la API
            async function loadApiModels(apiKey) {
                try {
                    // Verificar que la API key sea válida
                    if (!apiKey || apiKey === 'demo' || apiKey === 'tu-api-key-aquí') {
                        throw new Error('API key no válida o no encontrada');
                    }

                    console.log('Cargando modelos con API key: ********');

                    // Mostrar indicador de carga
                    apiModelsContainer.innerHTML = `
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando modelos desde la API...</p>
                        </div>
                    `;

                    // Cargar modelos
                    apiModels = await loadModelsFromOpenRouterAPI(apiKey);

                    // Renderizar modelos
                    renderApiModels();

                    // Actualizar selector de modelos
                    populateModelSelect();

                    return apiModels; // Devolver los modelos para uso posterior
                } catch (error) {
                    console.error('Error al cargar modelos de la API:', error);
                    apiModelsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error al cargar modelos de la API: ${error.message}
                        </div>
                    `;
                    throw error; // Re-lanzar el error para manejarlo en el llamador
                }
            }

            // Función para renderizar modelos locales
            function renderLocalModels() {
                if (localModels.length === 0) {
                    localModelsContainer.innerHTML = '<p class="text-muted">No hay modelos locales disponibles</p>';
                    return;
                }

                const modelsList = document.createElement('div');
                modelsList.className = 'list-group';

                localModels.forEach(model => {
                    const modelItem = document.createElement('a');
                    modelItem.href = '#';
                    modelItem.className = 'list-group-item list-group-item-action';
                    modelItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${model.name}</h6>
                            <small>${model.id.includes(':free') ? '<span class="badge bg-success">Gratis</span>' : ''}</small>
                        </div>
                        <small class="text-muted">${model.provider} - ${model.specialty || 'General'}</small>
                    `;

                    modelItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        modelSelect.value = model.id;
                    });

                    modelsList.appendChild(modelItem);
                });

                localModelsContainer.innerHTML = '';
                localModelsContainer.appendChild(modelsList);
            }

            // Función para renderizar modelos de la API
            function renderApiModels() {
                if (apiModels.length === 0) {
                    apiModelsContainer.innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> No hay modelos disponibles desde la API</h6>
                            <p>Para cargar los modelos, ingresa tu API key de OpenRouter y haz clic en el botón "Cargar modelos de la API".</p>
                        </div>
                    `;
                    return;
                }

                const modelsList = document.createElement('div');
                modelsList.className = 'list-group';

                apiModels.forEach(model => {
                    const modelItem = document.createElement('a');
                    modelItem.href = '#';
                    modelItem.className = 'list-group-item list-group-item-action';

                    // Determinar si el modelo es gratuito
                    const isFree = model.id.includes(':free') || (model.context_length_free && model.context_length_free > 0);

                    modelItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${model.name}</h6>
                            <small>${isFree ? '<span class="badge bg-success">Gratis</span>' : ''}</small>
                        </div>
                        <small class="text-muted">${model.provider} - ${model.specialty || 'General'}</small>
                        ${model.context_length ? `<div><small>Contexto: ${model.context_length} tokens</small></div>` : ''}
                    `;

                    modelItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        modelSelect.value = model.id;
                    });

                    modelsList.appendChild(modelItem);
                });

                apiModelsContainer.innerHTML = '';
                apiModelsContainer.appendChild(modelsList);
            }

            // Función para poblar el selector de modelos
            function populateModelSelect() {
                // Combinar modelos locales y de la API
                const allModels = [...localModels, ...apiModels];

                // Limpiar selector
                modelSelect.innerHTML = '';

                // Agrupar modelos por proveedor
                const modelsByProvider = {};
                allModels.forEach(model => {
                    const provider = model.provider || 'Otro';
                    if (!modelsByProvider[provider]) {
                        modelsByProvider[provider] = [];
                    }
                    modelsByProvider[provider].push(model);
                });

                // Crear grupos de opciones
                Object.keys(modelsByProvider).sort().forEach(provider => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = provider;

                    // Ordenar modelos por nombre
                    modelsByProvider[provider].sort((a, b) => a.name.localeCompare(b.name)).forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = `${model.name}${model.id.includes(':free') ? ' (Gratis)' : ''}`;
                        optgroup.appendChild(option);
                    });

                    modelSelect.appendChild(optgroup);
                });

                // Seleccionar el primer modelo
                if (modelSelect.options.length > 0) {
                    modelSelect.selectedIndex = 0;
                }
            }

            // Función para mostrar resultados
            function showResult(type, message, modelUsed = null) {
                let content = '';

                if (type === 'loading') {
                    // Mostrar toast para loading
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    });

                    Toast.fire({
                        icon: 'info',
                        title: message
                    });

                    content = `
                        <div class="d-flex align-items-center">
                            <div class="loading me-2"></div>
                            <span>${message}</span>
                        </div>
                    `;
                } else if (type === 'error') {
                    // Mostrar error con SweetAlert
                    Swal.fire({
                        title: 'Error',
                        html: message,
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });

                    content = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Error:</strong> ${message}
                        </div>
                    `;
                } else if (type === 'success') {
                    // Mostrar éxito con SweetAlert
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    });

                    Toast.fire({
                        icon: 'success',
                        title: `Respuesta recibida de ${modelUsed || 'modelo'}`
                    });

                    content = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Respuesta exitosa</strong>
                            ${modelUsed ? `<div class="mt-1 small">Modelo usado: ${modelUsed}</div>` : ''}
                        </div>
                        <div class="markdown-content">${parseMarkdown(message)}</div>
                    `;
                } else if (type === 'demo') {
                    // Mostrar demo con SweetAlert
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    });

                    Toast.fire({
                        icon: 'info',
                        title: `Respuesta de demostración generada`
                    });

                    content = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Modo de Demostración</strong>
                            ${modelUsed ? `<div class="mt-1 small">Modelo simulado: ${modelUsed}</div>` : ''}
                        </div>
                        <div class="markdown-content">${parseMarkdown(message)}</div>
                    `;
                }

                resultContainer.innerHTML = content;
            }
        });
    </script>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5 border-top">
        <div class="container">
            <div class="row justify-content-between align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5 class="h6 fw-bold text-primary">Marduk</h5>
                    <p class="small text-secondary mb-0">Ecosistema de soluciones para la transformación judicial</p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0 text-center">
                    <div class="d-flex flex-wrap justify-content-center gap-3 footer-links">
                        <a href="../pages/about.html" class="text-decoration-none text-secondary small">Acerca de</a>
                        <a href="../pages/policies.html" class="text-decoration-none text-secondary small">Políticas</a>
                        <a href="../pages/contribute.html" class="text-decoration-none text-secondary small">Contribuir</a>
                        <a href="../pages/support.html" class="text-decoration-none text-secondary small">Soporte</a>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <p class="small text-muted mb-0">© 2025 Rama Judicial de Colombia</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Inicializar el toggle de tema -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Inicializar el toggle de tema
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
          // Actualizar el icono según el tema actual
          if (document.body.classList.contains('dark-mode')) {
            themeToggle.querySelector('i').classList.remove('fa-moon');
            themeToggle.querySelector('i').classList.add('fa-sun');
          }

          // Agregar evento de click
          themeToggle.addEventListener('click', function() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
              document.documentElement.removeAttribute('data-theme');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('darkModeEnabled', 'false');
            } else {
              document.documentElement.setAttribute('data-theme', 'dark');
              document.body.classList.add('dark-mode');
              localStorage.setItem('darkModeEnabled', 'true');
            }

            // Actualizar el icono
            const themeIcon = themeToggle.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
              themeIcon.classList.remove('fa-moon');
              themeIcon.classList.add('fa-sun');
            } else {
              themeIcon.classList.remove('fa-sun');
              themeIcon.classList.add('fa-moon');
            }
          });
        }
      });
    </script>
</body>
</html>
