<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Directa de .env - Marduk</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Toastify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/search.css">
    <link rel="stylesheet" href="../css/fixes.css">

    <!-- Tema oscuro/claro -->
    <script>
      // Verificar preferencia guardada
      const darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
      // Verificar preferencia del sistema
      const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

      // Aplicar tema oscuro si está habilitado o preferido por el sistema
      if (darkModeEnabled || (prefersDarkMode && darkModeEnabled !== 'false')) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.addEventListener('DOMContentLoaded', function() {
          if (document.body) document.body.classList.add('dark-mode');
        });
        localStorage.setItem('darkModeEnabled', 'true');
      }
    </script>

    <style>
        .log {
            margin-top: 20px;
            padding: 10px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log p {
            margin: 5px 0;
            font-family: monospace;
        }
        .log .info {
            color: var(--info);
        }
        .log .success {
            color: var(--success);
        }
        .log .error {
            color: var(--danger);
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
        }
        pre {
            background-color: var(--code-bg);
            color: var(--code-color);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .dark-mode pre {
            background-color: #343a40;
            color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <img src="../img/logo-marduk.svg" alt="Marduk Logo" height="30" class="me-2">
                <span class="fw-bold">Marduk</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarMain">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html"><i class="fas fa-home me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/solutions.html"><i class="fas fa-puzzle-piece me-1"></i> Soluciones</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/community.html"><i class="fas fa-users me-1"></i> Comunidad</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../pages/ai-test.html"><i class="fas fa-robot me-1"></i> Prueba IA</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html"><i class="fas fa-vial me-1"></i> Tests</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <!-- Search Form -->
                    <form class="d-flex me-2 search-container">
                        <div class="position-relative w-100">
                            <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                            <input class="form-control ps-5" type="search" placeholder="Buscar..." aria-label="Search">
                        </div>
                    </form>
                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="btn btn-link text-light me-3">
                        <i class="fas fa-moon"></i>
                    </button>
                    <!-- User Menu -->
                    <div class="dropdown">
                        <button class="btn btn-link d-flex align-items-center text-light text-decoration-none dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="avatar-circle avatar-circle-sm bg-primary text-white me-2">
                                AF
                            </div>
                            <span class="d-none d-md-block">Alexander Fadul</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                            <li><a class="dropdown-item" href="../pages/profile.html"><i class="fas fa-user me-2"></i> Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="../pages/settings.html"><i class="fas fa-cog me-2"></i> Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <!-- Botón para volver a la página anterior -->
                <a href="javascript:history.back()" class="back-link">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                </a>

                <h1 class="mb-4"><i class="fas fa-key text-primary me-2"></i> Prueba Directa de .env</h1>
                <p class="lead mb-4">Esta página demuestra diferentes métodos para acceder a las variables de entorno en el archivo .env.</p>

                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i> Advertencia de Seguridad</h5>
                    <p>El archivo <code>.env</code> contiene información sensible como API keys y credenciales. <strong>No debe ser accesible directamente desde el navegador</strong>.</p>
                    <p>Esta página muestra métodos seguros e inseguros para acceder a las variables de entorno. Los métodos inseguros se muestran solo con fines educativos.</p>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i> Métodos Inseguros (No Recomendados)</h5>
                            </div>
                            <div class="card-body">
                                <p>Estos métodos intentan acceder directamente al archivo .env, lo que representa un riesgo de seguridad.</p>
                                
                                <div class="mb-3">
                                    <button id="load-env" class="btn btn-outline-danger me-2 mb-2"><i class="fas fa-file-alt me-1"></i> Cargar .env</button>
                                    <button id="load-env-test2" class="btn btn-outline-danger me-2 mb-2"><i class="fas fa-file-code me-1"></i> Cargar .env.test2</button>
                                </div>
                                
                                <div id="result" class="result">
                                    <p>Haz clic en un botón para intentar cargar el archivo .env</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i> Métodos Seguros (Recomendados)</h5>
                            </div>
                            <div class="card-body">
                                <p>Estos métodos utilizan técnicas seguras para acceder a las variables de entorno sin exponer el archivo .env.</p>
                                
                                <div class="mb-3">
                                    <button id="load-env-proxy" class="btn btn-success me-2 mb-2"><i class="fas fa-server me-1"></i> Usar Proxy del Servidor</button>
                                    <button id="load-env-hardcoded" class="btn btn-outline-secondary me-2 mb-2"><i class="fas fa-code me-1"></i> Usar Variable Temporal</button>
                                </div>
                                
                                <div id="secure-result" class="result">
                                    <p>Haz clic en un botón para obtener la API key de forma segura</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-terminal me-2"></i> Log de Operaciones</h5>
                    </div>
                    <div class="card-body">
                        <div id="log" class="log">
                            <p class="info">Log de operaciones:</p>
                        </div>
                        <div class="mt-3">
                            <button id="clear-log" class="btn btn-outline-secondary"><i class="fas fa-broom me-1"></i> Limpiar Log</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5 border-top">
        <div class="container">
            <div class="row justify-content-between align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5 class="h6 fw-bold text-primary">Marduk</h5>
                    <p class="small text-secondary mb-0">Ecosistema de soluciones para la transformación judicial</p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0 text-center">
                    <div class="d-flex flex-wrap justify-content-center gap-3 footer-links">
                        <a href="../pages/about.html" class="text-decoration-none text-secondary small">Acerca de</a>
                        <a href="../pages/policies.html" class="text-decoration-none text-secondary small">Políticas</a>
                        <a href="../pages/contribute.html" class="text-decoration-none text-secondary small">Contribuir</a>
                        <a href="../pages/support.html" class="text-decoration-none text-secondary small">Soporte</a>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <p class="small text-muted mb-0">© 2025 Rama Judicial de Colombia</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Toastify -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0"></script>
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resultDiv = document.getElementById('result');
            const secureResultDiv = document.getElementById('secure-result');
            const logDiv = document.getElementById('log');
            
            // Configurar el botón de cambio de tema
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', function() {
                const isDarkMode = document.body.classList.contains('dark-mode');
                if (isDarkMode) {
                    document.body.classList.remove('dark-mode');
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('darkModeEnabled', 'false');
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    document.body.classList.add('dark-mode');
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('darkModeEnabled', 'true');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
            });
            
            // Actualizar el ícono del botón de tema según el modo actual
            if (document.body.classList.contains('dark-mode')) {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Función para agregar mensajes al log
            function log(message, type = 'info') {
                const p = document.createElement('p');
                p.className = type;
                p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logDiv.appendChild(p);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            
            // Función para cargar el archivo .env (método inseguro)
            async function loadEnvFile(filePath) {
                log(`Intentando cargar ${filePath}...`);
                
                try {
                    const response = await fetch(filePath);
                    
                    if (response.ok) {
                        const content = await response.text();
                        log(`Archivo ${filePath} cargado correctamente. Longitud: ${content.length} caracteres`, 'success');
                        
                        // Mostrar alerta con SweetAlert2
                        Swal.fire({
                            title: '¡Advertencia de Seguridad!',
                            text: `El archivo ${filePath} es accesible públicamente. Esto representa un riesgo de seguridad.`,
                            icon: 'warning',
                            confirmButtonText: 'Entendido'
                        });
                        
                        // Procesar el contenido
                        const env = {};
                        const lines = content.split('\n');
                        log(`Número de líneas: ${lines.length}`);
                        
                        lines.forEach((line, index) => {
                            // Ignorar líneas vacías o comentarios
                            if (!line || line.startsWith('#')) {
                                log(`Línea ${index + 1}: Comentario o vacía`);
                                return;
                            }
                            
                            // Extraer clave y valor
                            const match = line.match(/^([^=]+)=(.*)$/);
                            if (match) {
                                const [, key, value] = match;
                                // Eliminar comillas si existen
                                let cleanValue = value.trim();
                                
                                // Eliminar comillas dobles
                                if (cleanValue.startsWith('"') && cleanValue.endsWith('"')) {
                                    cleanValue = cleanValue.substring(1, cleanValue.length - 1);
                                    log(`Línea ${index + 1}: Comillas dobles eliminadas`);
                                }
                                
                                // Eliminar comillas simples
                                if (cleanValue.startsWith("'") && cleanValue.endsWith("'")) {
                                    cleanValue = cleanValue.substring(1, cleanValue.length - 1);
                                    log(`Línea ${index + 1}: Comillas simples eliminadas`);
                                }
                                
                                env[key.trim()] = cleanValue;
                                log(`Línea ${index + 1}: Variable ${key.trim()} = ${cleanValue.substring(0, 3)}...`, 'success');
                            } else {
                                log(`Línea ${index + 1}: Formato inválido`, 'error');
                            }
                        });
                        
                        // Mostrar resultado
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i> ¡Advertencia de Seguridad!</h5>
                                <p>El archivo ${filePath} es accesible públicamente. Esto representa un riesgo de seguridad.</p>
                            </div>
                            <h6>Variables de entorno cargadas:</h6>
                            <pre>${JSON.stringify(env, null, 2)}</pre>
                            <p><strong>API Key:</strong> ${env.OPENROUTER_API_KEY ? env.OPENROUTER_API_KEY.substring(0, 10) + '...' : 'No encontrada'}</p>
                            <div class="mt-3">
                                <h6>Recomendaciones:</h6>
                                <ul>
                                    <li>Cambiar los permisos del archivo a 600 o 640</li>
                                    <li>Configurar reglas en .htaccess para bloquear el acceso</li>
                                </ul>
                            </div>
                        `;
                        
                        return env;
                    } else {
                        log(`Error al cargar ${filePath}: ${response.status} ${response.statusText}`, 'error');
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-circle me-2"></i> Acceso Bloqueado (Correcto)</h5>
                                <p>El archivo ${filePath} no es accesible directamente. Esto es lo esperado por seguridad.</p>
                            </div>
                            <p>Código de estado: ${response.status}</p>
                            <p>Mensaje: ${response.statusText}</p>
                        `;
                        
                        // Mostrar alerta con SweetAlert2
                        Swal.fire({
                            title: 'Acceso Bloqueado (Correcto)',
                            text: `El archivo ${filePath} no es accesible directamente. Esto es lo esperado por seguridad.`,
                            icon: 'success',
                            confirmButtonText: 'Entendido'
                        });
                        
                        return null;
                    }
                } catch (error) {
                    log(`Error al cargar ${filePath}: ${error.message}`, 'error');
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i> Acceso Bloqueado (Correcto)</h5>
                            <p>Error al acceder al archivo ${filePath}. Esto es lo esperado por seguridad.</p>
                        </div>
                        <p>Error: ${error.message}</p>
                    `;
                    
                    // Mostrar alerta con SweetAlert2
                    Swal.fire({
                        title: 'Acceso Bloqueado (Correcto)',
                        text: `Error al acceder al archivo ${filePath}. Esto es lo esperado por seguridad.`,
                        icon: 'success',
                        confirmButtonText: 'Entendido'
                    });
                    
                    return null;
                }
            }
            
            // Función para obtener la API key de forma segura vía proxy
            async function getApiKeyViaProxy() {
                log('Obteniendo API key vía proxy del servidor...', 'info');
                secureResultDiv.innerHTML = `<p>Obteniendo API key vía proxy...</p>`;
                
                try {
                    // Primero, obtener un token de autenticación
                    const tokenResponse = await fetch('/get-auth-token.php');
                    if (!tokenResponse.ok) {
                        throw new Error(`Error al obtener token: ${tokenResponse.status} ${tokenResponse.statusText}`);
                    }
                    
                    const tokenData = await tokenResponse.json();
                    if (!tokenData.success || !tokenData.data || !tokenData.data.token) {
                        throw new Error('Formato de respuesta de token inválido');
                    }
                    
                    log('Token de autenticación obtenido correctamente', 'success');
                    const token = tokenData.data.token;
                    
                    // Luego, usar el token para obtener la API key
                    const apiKeyResponse = await fetch('/get-api-key.php', {
                        headers: {
                            'X-Auth-Token': token
                        }
                    });
                    
                    if (!apiKeyResponse.ok) {
                        throw new Error(`Error al obtener API key: ${apiKeyResponse.status} ${apiKeyResponse.statusText}`);
                    }
                    
                    const apiKeyData = await apiKeyResponse.json();
                    if (!apiKeyData.success) {
                        throw new Error(apiKeyData.message || 'Error desconocido');
                    }
                    
                    log('API key obtenida correctamente vía proxy', 'success');
                    
                    // Mostrar resultado
                    secureResultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i> API Key Obtenida de Forma Segura</h5>
                            <p>La API key se obtuvo correctamente a través del proxy del servidor.</p>
                        </div>
                        <p><strong>API Key Disponible:</strong> ${apiKeyData.data.keyAvailable ? 'Sí' : 'No'}</p>
                        ${apiKeyData.data.key ? `<p><strong>API Key (primeros 10 caracteres):</strong> ${apiKeyData.data.key.substring(0, 10)}...</p>` : ''}
                        <div class="mt-3">
                            <h6>Ventajas de este método:</h6>
                            <ul>
                                <li>El archivo .env nunca se expone directamente</li>
                                <li>Se utiliza autenticación mediante tokens</li>
                                <li>Solo se devuelve la información necesaria</li>
                                <li>Compatible con permisos restrictivos (600/640) en el archivo .env</li>
                            </ul>
                        </div>
                    `;
                    
                    // Mostrar alerta con SweetAlert2
                    Swal.fire({
                        title: 'Éxito',
                        text: 'API key obtenida de forma segura',
                        icon: 'success',
                        confirmButtonText: 'Genial'
                    });
                } catch (error) {
                    log(`Error al obtener API key vía proxy: ${error.message}`, 'error');
                    secureResultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-circle me-2"></i> Error</h5>
                            <p>No se pudo obtener la API key: ${error.message}</p>
                        </div>
                        <p>Asegúrate de que los scripts PHP de proxy estén correctamente configurados en el servidor.</p>
                    `;
                    
                    // Mostrar alerta con SweetAlert2
                    Swal.fire({
                        title: 'Error',
                        text: `No se pudo obtener la API key: ${error.message}`,
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                }
            }
            
            // Función para usar una variable temporal (método seguro)
            function useTemporaryVariable() {
                log('Usando variable temporal para la API key...', 'info');
                
                // Crear una variable temporal que solo existe durante la sesión
                const tempApiKey = "API_KEY_TEMPORAL_" + Math.random().toString(36).substring(2, 15);
                log('Variable temporal creada correctamente', 'success');
                
                // Mostrar resultado
                secureResultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i> Variable Temporal Creada</h5>
                        <p>Se ha creado una variable temporal para la API key que solo existe durante esta sesión.</p>
                    </div>
                    <p><strong>Variable Temporal:</strong> ${tempApiKey.substring(0, 15)}...</p>
                    <div class="mt-3">
                        <h6>Ventajas de este método:</h6>
                        <ul>
                            <li>La API key real nunca se expone en el código fuente</li>
                            <li>La variable temporal solo existe durante la sesión actual</li>
                            <li>No se requiere acceso al archivo .env</li>
                            <li>Útil para pruebas y desarrollo local</li>
                        </ul>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-info-circle me-2"></i> Nota Importante:</h6>
                        <p>Para aplicaciones en producción, es recomendable usar el método del proxy del servidor para obtener la API key de forma segura.</p>
                    </div>
                `;
                
                // Mostrar toast con Toastify
                Toastify({
                    text: "Variable temporal creada correctamente",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    stopOnFocus: true
                }).showToast();
            }
            
            // Evento para cargar .env (método inseguro)
            document.getElementById('load-env').addEventListener('click', () => {
                loadEnvFile('.env');
            });
            
            // Evento para cargar .env.test2 (método inseguro)
            document.getElementById('load-env-test2').addEventListener('click', () => {
                loadEnvFile('.env.test2');
            });
            
            // Evento para usar el proxy del servidor (método seguro)
            document.getElementById('load-env-proxy').addEventListener('click', () => {
                getApiKeyViaProxy();
            });
            
            // Evento para usar una variable temporal (método seguro)
            document.getElementById('load-env-hardcoded').addEventListener('click', () => {
                useTemporaryVariable();
            });
            
            // Evento para limpiar el log
            document.getElementById('clear-log').addEventListener('click', () => {
                logDiv.innerHTML = '<p class="info">Log de operaciones:</p>';
                
                // Mostrar toast con Toastify
                Toastify({
                    text: "Log limpiado correctamente",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    stopOnFocus: true
                }).showToast();
            });
        });
    </script>
</body>
</html>
